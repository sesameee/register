var _downloadPlugin=function(options){this.params={stepNum:"0",fid:"",version:1,status:0,down_session:"",urlschemes:"",appendParams:"",androidUrl:"",appDomain:"",ajaxPrefix:"https://jsapi.app2.cn"};this.el=null;this.nomalClass="";this.disabledClass="";this.loadingClass="";this.processColor="";this.setStyle=function(type){if(this.fixed){if(this.params.status==1){this.setStepClass()}else{this.downHelp.style.display="block";this.downHelp.innerHTML="应用未上架"}}else{switch(type){case 1:this.el.querySelector("a").style.color=getComputedStyle(this.el).color;this.el.querySelector("a").style.display="block";this.el.querySelector("a").style.textDecoration="none";this.el.querySelector("span").style.position="relative";this.el.querySelector("span").style.zIndex=1;this.el.querySelector("em").style.display="block";this.el.querySelector("em").style.position="absolute";this.el.querySelector("em").style.top="0";this.el.querySelector("em").style.left="0";this.el.querySelector("em").style.height="100%";this.el.querySelector("em").style.background=this.processColor;this.el.querySelector("em").style.width="0";break;case 2:if(this.el.className.indexOf(this.loadingClass)==-1){this.el.className=this.el.className+" "+this.loadingClass}this.el.querySelector("a").style.color=getComputedStyle(this.el).color;break;default:this.el.style.position="relative";this.el.innerHTML="<a></a>";if(this.params.status==1){if(this.el.className.indexOf(this.nomalClass)==-1){this.el.className=this.el.className+" "+this.nomalClass}if(this.el.className.indexOf(this.disabledClass)!=-1){var arr=this.el.className.split(" ");var idx=arr.indexOf(this.disabledClass);arr.splice(idx,1);this.el.className=arr.join(" ")}this.el.querySelector("a").innerHTML="免费安装"}else{if(this.el.className.indexOf(this.disabledClass)==-1){this.el.className=this.el.className+" "+this.disabledClass}if(this.el.className.indexOf(this.nomalClass)!=-1){var arr=this.el.className.split(" ");var idx=arr.indexOf(this.nomalClass);arr.splice(idx,1);this.el.className=arr.join(" ")}this.el.querySelector("a").innerHTML="未上架"}this.el.querySelector("a").style.color=getComputedStyle(this.el).color;this.el.querySelector("a").style.display="block";this.el.querySelector("a").style.textDecoration="none";if(this.params.status==1){this.setStepClass()}break}}};this.setStepClass=function(){var me=this;if(me.params.stepNum){me.bindInstallBtnEvent(me.params.stepNum)}else{if(me.params.clickRun){me.el.onclick=function(){me.bindInstallBtnEvent("0")}}else{if(me.params.delayRun){window.setTimeout(function(){me.bindInstallBtnEvent("0")},me.params.delayRun)}else{me.bindInstallBtnEvent("0")}}}};this.bindInstallBtnEvent=function(stepNum){var me=this;var ua=navigator.userAgent;if((navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i))){if((/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/baidubrowser/.test(navigator.userAgent))){var name="___APPIOS__";if(stepNum=="0"){var loadxml=me.params.ajaxPrefix+"/api/loadxml?fid="+me.params.fid+"&params="+me.params.appendParams+"&sid="+me.params.sid+"&VIT="+me.params.VIT+"&XSE="+me.params.XSE+"&appdomain="+me.params.appDomain;if(!me.fixed){me.el.querySelector("a").innerHTML="免费安装";me.el.querySelector("a").href=loadxml}document.cookie=name+"="+(+new Date);setTimeout(function(){location.href=loadxml},500);if(me.params.version==1){setTimeout(function(){location.href=me.params.ajaxPrefix+"/api/loadprovision"+"&sid="+me.params.sid+"&VIT="+me.params.VIT+"&XSE="+me.params.XSE+"&appdomain="+me.params.appDomain},3000)}me.el.onclick=function(){if(me.params.version==1){setTimeout(function(){location.href=me.params.ajaxPrefix+"/api/loadprovision"+"&sid="+me.params.sid+"&VIT="+me.params.VIT+"&XSE="+me.params.XSE+"&appdomain="+me.params.appDomain},3000)}}}else{if(stepNum=="2"){if(me.fixed){me.downHelp.style.display="block";me.downHelp.innerHTML="准备中..."}else{me.el.innerHTML="<a><span>等待下载</span><em></em></a>";me.setStyle(1);me.el.querySelector("span").innerHTML="准备中..."}me.ajax({url:me.params.ajaxPrefix+"/api/downloadApp",data:{taskId:me.getUrlParam("taskId"),down_session:me.params.down_session,sid:me.params.sid,VIT:me.params.VIT,XSE:me.params.XSE,appdomain:me.params.appDomain},success:function(rs){rs=JSON.parse(rs);if(rs.code==1){if(!me.fixed){me.el.querySelector("a").href=rs.url}location.href=rs.url;var fileSize,downloadPercentage,installTime;me.ajax({url:me.params.progress_url,jsonp:"cb",success:function(rs){fileSize=rs.total;installTime=Math.ceil(parseInt(fileSize)*0.000024414*2);installTime=installTime<10?10:installTime}});var countDownTime=30;i=setInterval(function(){me.ajax({url:me.params.progress_url,jsonp:"cb",success:function(rs){downloadPercentage=rs.downRadio;if(downloadPercentage<100&&downloadPercentage>0){if(me.fixed){me.downHelp.style.display="block";me.downHelp.innerHTML="下载中"+downloadPercentage+"%"}else{me.el.querySelector("a").href="javascript:void(0)";me.setStyle(2);me.el.querySelector("span").innerHTML="下载中 <b>"+downloadPercentage+"%</b>";me.el.querySelector("b").style.display="inline-block";me.el.querySelector("b").style.verticalAlign="middle";me.el.querySelector("em").style.width=downloadPercentage+"%";me.el.querySelector("em").style.display="block"}}else{if(downloadPercentage==100){clearInterval(i);j=setInterval(function(){if(!me.fixed){var arr=me.el.className.split(" ");var idx=arr.indexOf(me.loadingClass);if(idx!=-1){arr.splice(idx,1)}me.el.className=arr.join(" ");me.el.querySelector("em").style.display="none"}if(installTime>0){if(me.fixed){me.downHelp.style.display="block";me.downHelp.innerHTML="安装中..."+installTime+"秒"}else{me.el.querySelector("span").innerHTML="安装中..."+installTime+"秒"}installTime--}else{clearInterval(j);if(me.fixed){me.downHelp.innerHTML="打开";if(me.params.urlschemes!=""){me.downHelp.onclick=function(){location.href=me.params.urlschemes+"://"}}else{me.downHelp.innerHTML="在桌面打开"}}else{if(me.params.urlschemes!=""){me.el.querySelector("span").innerHTML="打开";me.el.querySelector("a").href=me.params.urlschemes+"://"}else{me.el.querySelector("span").innerHTML="在桌面打开"}}}},1000)}else{if(countDownTime>0){if(me.fixed){me.downHelp.style.display="block";me.downHelp.innerHTML="准备中..."+countDownTime+"秒"}else{me.el.querySelector("span").innerHTML="准备中..."+countDownTime+"秒"}countDownTime--}else{if(me.fixed){me.downHelp.style.display="block";me.downHelp.innerHTML="下载中 <b>"+1+"%</b>"}else{if(me.el.className.indexOf(me.loadingClass)==-1){me.el.className=me.el.className+" "+me.loadingClass}me.el.querySelector("a").style.color=getComputedStyle(me.el).color;me.el.querySelector("span").innerHTML="下载中 <b>"+1+"%</b>";me.el.querySelector("em").style.display="block";me.el.querySelector("em").style.width=1+"%"}}}}},error:function(){}})},1000)}else{location.reload()}},error:function(rs){alert("应用加载失败,请重试!");location.reload()}})}}}else{me.el.onclick=function(){alert("该应用只支持iOS,需在iOS设备Safari中访问及安装")}}}else{if(/(Android|Linux)/i.test(ua)){me.el.onclick=function(){if(me.params.androidUrl){location.href=androidUrl}else{alert("该应用只支持iOS,需在iOS设备Safari中访问及安装")}}}else{me.el.onclick=function(){alert("该应用只支持iOS,需在iOS设备Safari中访问及安装")}}}};this.getUrlParam=function(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)");var r=window.location.search.substr(1).match(reg);if(r!=null){return unescape(r[2])}return null};this.ajax=function(params){params=params||{};params.data=params.data||{};var json=params.jsonp?jsonp(params):json(params);function json(params){params.type=(params.type||"GET").toUpperCase();params.data=formatParams(params.data);var xhr=null;if(window.XMLHttpRequest){xhr=new XMLHttpRequest()}else{xhr=new ActiveXObjcet("Microsoft.XMLHTTP")}xhr.onreadystatechange=function(){if(xhr.readyState==4){var status=xhr.status;if(status>=200&&status<300){var response="";var type=xhr.getResponseHeader("Content-type");if(type.indexOf("xml")!==-1&&xhr.responseXML){response=xhr.responseXML}else{if(type==="application/json"){response=JSON.parse(xhr.responseText)}else{response=xhr.responseText}}params.success&&params.success(response)}else{params.error&&params.error(status)}}};if(params.type=="GET"){xhr.open(params.type,params.url+"?"+params.data,true);xhr.send(null)}else{xhr.open(params.type,params.url,true);xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");xhr.send(params.data)}}function jsonp(params){var callbackName=params.jsonp;var head=document.getElementsByTagName("head")[0];params.data["callback"]=callbackName;var data=formatParams(params.data);var script=document.createElement("script");head.appendChild(script);window[callbackName]=function(json){head.removeChild(script);clearTimeout(script.timer);window[callbackName]=null;params.success&&params.success(json)};if(params.url.indexOf("?")!=-1){script.src=params.url+"&"+data}else{script.src=params.url+"?"+data}if(params.time){script.timer=setTimeout(function(){window[callbackName]=null;head.removeChild(script);params.error&&params.error({message:"超时"})},time)}}function formatParams(data){var arr=[];for(var name in data){arr.push(encodeURIComponent(name)+"="+encodeURIComponent(data[name]))}arr.push("v="+random());return arr.join("&")}function random(){return Math.floor(Math.random()*10000+500)}};if(!options.el||!options.appDomain){alert("el和appDomain为必须设置的属性");return}this.el=document.querySelector(options.el);this.fixed=options.downloadFixed?options.downloadFixed:false;if(!this.fixed){this.nomalClass=options.btnNormalClass;this.disabledClass=options.btnDiableClass;this.loadingClass=options.btnLoadingClass;this.processColor=options.processBarColor?options.processBarColor:"rgba(4, 119, 249, 1)"}this.params.delayRun=options.delayRun*1000;this.params.clickRun=options.clickRun;this.params.appDomain=options.appDomain;if(this.fixed){var downHelp=document.createElement("div");downHelp.style.minWidth="10em";downHelp.style.height="4em";downHelp.style.background="#fff";downHelp.style.borderRadius="10px";downHelp.style.lineHeight="4em";downHelp.style.textAlign="center";downHelp.style.position="fixed";downHelp.style.top="50%";downHelp.style.left="50%";downHelp.style.transform="translate(-50%, -50%)";downHelp.style.color="rgb(33, 150, 243)";downHelp.style.marginTop="-70px";downHelp.style.boxShadow="rgba(33, 150, 243, 0.5) 0px 4px 5px";downHelp.style.display="none";downHelp.style.fontSize="5em";document.body.appendChild(downHelp);this.downHelp=downHelp}var me=this;this.ajax({url:me.params.ajaxPrefix+"/api/getinfo.json",data:{appdomain:me.params.appDomain},success:function(res){var data=JSON.parse(res);me.params.stepNum=me.getUrlParam("step");me.params.fid=me.getUrlParam("fid");for(var i in data){me.params[i]=data[i]}if(!localStorage.getItem("__jx__app__id__")&&me.params.fid){localStorage.setItem("__jx__app__id__",me.params.fid)}me.setStyle()},error:function(res){alert("获取状态失败，请确认appdomain是否正确")}})};window.DowloadBtnPlugin=_downloadPlugin;